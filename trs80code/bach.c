
#include <stdio.h> 
#include <malloc.h>

#define byte unsigned char
#define mallocblock 2048
#define HOLD_TIME 1

__sfr __at 0x82 PORTX82;
__sfr __at 0x83 PORTX83;
__sfr __at 0x84 PORTX84;
__sfr __at 0x85 PORTX85;


long heap;
uint memBlockPtr = 47000;
int n;


int vArray_pitch[12];
byte vArray_volume[12];

char buf[4];
uint temp2;
uint temp;


void hold(unsigned int x) {
    for(unsigned int y = 0; y<x;y++) {
      #pragma asm
      nop
      #pragma endasm
    }
}


unsigned char bitArray[256] = {0,128,64,192,32,160,96,224,16,144,80,208,48,176,112,240,8,136,72,200,40,168,104,232,24,152,
    88,216,56,184,120,248,4,132,68,196,36,164,100,228,20,148,84,212,52,180,116,244,12,140,76,204,44,172,108,236,28,156,92,
    220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,
    58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,
    190,126,254,1,129,65,193,33,161,97,225,17,145,81,209,49,177,113,241,9,137,73,201,41,169,105,233,25,153,89,217,57,185,
    121,249,5,133,69,197,37,165,101,229,21,149,85,213,53,181,117,245,13,141,77,205,45,173,109,237,29,157,93,221,61,189,125,
    253,3,131,67,195,35,163,99,227,19,147,83,211,51,179,115,243,11,139,75,203,43,171,107,235,27,155,91,219,59,187,123,251,7,
    135,71,199,39,167,103,231,23,151,87,215,55,183,119,247,15,143,79,207,47,175,111,239,31,159,95,223,63,191,127,255}; 

/*
unsigned char reverseBits(unsigned char v)
{
//    v = ((v >> 1) & 0x55) | ((v & 0x55) << 1);
//    v = ((v >> 2) & 0x33) | ((v & 0x33) << 2);
//    v = ((v >> 4) & 0x0F) | ((v & 0x0F) << 4);
//    return v;
    return bitArray[v];
}
*/

#define reverseBits(v) bitArray[v]


void setVolume(byte bPort, byte bChipVoiceNum, byte bVolume) {
	byte bx;

	bx = (bChipVoiceNum << 5);
	bx = (bx | 0x90);
    bx = (bx | bVolume);
    bx = reverseBits(bx);

    switch(bPort) {
    	case 0x82:
    	    PORTX82 = bx;
    	break;

    	case 0x83:
    	    PORTX83 = bx;
    	break;

    	case 0x84:
    	    PORTX84 = bx;
    	break;

    	default:
    	    PORTX85 = bx;
    }    
}

byte bPastVolume[12] = { 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255 };

void sound(byte bVoiceNumber, int pitch, byte volume) {
    byte bPort;
    byte bChipVoiceNum;
    byte rightfourbits;
    byte leftsixbits;
    byte b1;

    if(bVoiceNumber < 3) {
    	bPort = 0x82;
    	bChipVoiceNum = bVoiceNumber;
    }
    else if(bVoiceNumber < 6) {
    	bPort = 0x83;
        bChipVoiceNum = bVoiceNumber - 3;
    }
    else if(bVoiceNumber < 9) {
    	bPort = 0x84;
    	bChipVoiceNum = bVoiceNumber - 6;
    }
    else {
    	bPort = 0x85;
    	bChipVoiceNum = bVoiceNumber - 9;
    }
    
    //if(bPastVolume[bVoiceNumber] != volume) {
    	setVolume(bPort, bChipVoiceNum, 0x0f - volume);
    //	bPastVolume[bVoiceNumber] = volume;
    //}

    rightfourbits = (pitch & 0x000f);
    leftsixbits =   (byte)((int)(pitch & 0x03f0) >> 4);
    rightfourbits = (rightfourbits | 0x80);
    bChipVoiceNum = reverseBits(bChipVoiceNum) >> 5;
    b1 = reverseBits(rightfourbits);
    b1 = (b1 | bChipVoiceNum);
    leftsixbits = reverseBits(leftsixbits);

    switch(bPort) {
    	case 0x82:
    	    PORTX82 = b1;
    	    PORTX82 = leftsixbits;
    	break;

    	case 0x83:
    	    PORTX83 = b1;
    	    PORTX83 = leftsixbits;
    	break;

    	case 0x84:
    	    PORTX84 = b1;
    	    PORTX84 = leftsixbits;
    	break;

    	default:
    	    PORTX85 = b1;
    	    PORTX85 = leftsixbits;
    }
}


void cls() {
   void* p;
   p = 0x3c00;
   memset(p, ' ', 0x3ff);
}


#define charat(x,y,c)  memset(0x3c00+((y<<6) + x), c, 1);


void h_lineat(byte y, byte c) {
    void* p;
    uint cc = y;
    cc = cc * 64;

    p = 0x3c00 + cc;

    memset(p, c, 64);
}


void v_lineat(byte x, byte c) {
    for(uint j = 0; j < 16; j++) 
        charat(x, j, c);
}


void strat(byte x, byte y, char* s) {
    temp2 = strlen(s);
    for(uint i = 0; i < temp2; i++) {
        charat(x+i,y,*(s+i));
    }
}
 

void drawGrid() {
   uint j;
   char buf[7];

   j=1;
   for(uint i = 2;i<62;i=i+5) {
     v_lineat(i+2, 0x95);
     sprintf(buf,"%02d", j);
     if(j < 13) {
       strat(i+4,3,buf);
     }
     charat(i+1,3,' ');

     j++;
   }

   h_lineat(12, 0x8c);
   h_lineat(13, ' ');
   h_lineat(14, ' ');
   h_lineat(15, ' ');

   h_lineat(0, ' ');
   h_lineat(1, ' ');
   h_lineat(2, ' ');
   h_lineat(4, 0x8c);

   //strat(0,15,"COMPILED: YYYY-MM-DD-HH-MM-SS");
   strat(20,1,"J.S. BACH - INVENTION 13");
}


char mult_lu1[12] = {4, 9, 14, 19, 24, 29, 34, 39, 44, 49, 54, 59};
char mult_lu2[12] = {7,12, 17, 22, 27, 32, 37, 42, 47, 52, 57, 62};

void playVoices() { 
    register byte i;
    // scroll screen   
    //memcpy(15424,15488,64);
    //memcpy(15488,15552,64);
    //memcpy(15552,15616,64);
    //memcpy(15616,15680,64);
    memcpy(15680,15744,64);
    memcpy(15744,15808,64);
    memcpy(15808,15872,64);
    memcpy(15872,15936,64);
    memcpy(15936,16000,64);
    memcpy(16000,16064,64);

    char j;
    for(i=0;i<12;i++) {
        sound(i, vArray_pitch[i], vArray_volume[i]);
        itoa(vArray_pitch[i], buf, 16);
        temp = vArray_volume[i];
        if(temp < 0x0a)
           temp+=48;
        else
           temp+=55;
        j = mult_lu1[i]+1;
        charat(j+1, 11, ' ');
        charat(j+2, 11, ' ');
        strat(j, 11, buf);
        charat(mult_lu2[i]+1,11, temp);
    }
}



void silence() {
    for(uint i=255;i>=249;i=i-2) {
        PORTX82 = i;
        PORTX83 = i;
        PORTX84 = i;
        PORTX85 = i;
    }
}

uint throbctr = 0;
void throb() {
    throbctr++;
    switch((uint)(throbctr % 6)) {
        case 0:
            charat(63,15,129); // top left
            break;
        case 1:
            charat(63,15,130); // top right
            break;
        case 2:
            charat(63,15,136); // mid right
            break;
        case 3:
            charat(63,15,160); // bot right
            break;
        case 4:
            charat(63,15,144); // bot left
            break;
        default:
            charat(63,15,132); // mid left
    }
}




typedef struct {
    int iOffset;
    char iChannel;
    int iPitch;
    char iVolume;
} notestruct;

notestruct ns[] = {
    {0,1,512,15},
    {1,0,171,15},
    {2,0,128,15},
    {2,1,256,15},
    {3,0,108,15},
    {4,0,114,15},
    {5,0,171,15},
    {6,0,114,15},
    {6,1,271,15},
    {7,0,96,15},
    {8,0,108,15},
    {8,1,256,15},
    {9,1,341,15},
    {10,0,85,15},
    {10,1,256,15},
    {11,1,215,15},
    {12,0,135,15},
    {12,1,228,15},
    {13,1,341,15},
    {14,0,85,15},
    {14,1,228,15},
    {15,1,192,15},
    {16,0,128,15},
    {16,1,215,15},
    {17,0,171,15},
    {18,0,128,15},
    {18,1,256,15},
    {19,0,108,15},
    {20,0,114,15},
    {20,1,271,15},
    {21,0,171,15},
    {22,0,114,15},
    {22,1,341,15},
    {23,0,96,15},
    {24,0,108,15},
    {24,1,256,15},
    {25,1,341,15},
    {26,0,128,15},
    {26,1,256,15},
    {27,1,215,15},
    {28,0,128,0},
    {28,1,228,15},
    {29,1,341,15},
    {30,1,228,15},
    {31,1,192,15},
    {32,1,215,15},
    {33,0,85,15},
    {34,0,108,15},
    {34,1,256,15},
    {35,0,85,15},
    {36,0,128,15},
    {36,1,215,15},
    {37,0,108,15},
    {38,0,171,15},
    {38,1,256,15},
    {39,0,144,15},
    {40,0,161,15},
    {40,1,192,15},
    {41,1,256,15},
    {42,0,128,15},
    {42,1,322,15},
    {43,1,256,15},
    {44,0,96,15},
    {44,1,383,15},
    {45,1,322,15},
    {46,0,81,15},
    {46,1,512,15},
    {47,1,430,15},
    {48,1,456,15},
    {49,0,96,15},
    {50,0,114,15},
    {50,1,383,15},
    {51,0,96,15},
    {52,0,144,15},
    {52,1,287,15},
    {53,0,114,15},
    {54,0,192,15},
    {54,1,228,15},
    {55,0,161,15},
    {56,0,171,15},
    {57,1,287,15},
    {58,0,144,15},
    {58,1,341,15},
    {59,1,287,15},
    {60,0,108,15},
    {60,1,430,15},
    {61,1,341,15},
    {62,0,85,15},
    {62,1,574,15},
    {63,1,456,15},
    {64,1,512,15},
    {65,0,108,15},
    {66,0,128,15},
    {66,1,430,15},
    {67,0,108,15},
    {68,0,161,15},
    {68,1,383,15},
    {69,1,322,15},
    {70,0,96,15},
    {70,1,456,15},
    {71,1,383,15},
    {72,1,574,15},
    {73,0,114,15},
    {74,0,144,15},
    {74,1,456,15},
    {75,0,114,15},
    {76,0,171,15},
    {76,1,430,15},
    {77,1,341,15},
    {78,0,108,15},
    {78,1,512,15},
    {79,1,430,15},
    {80,1,644,15},
    {81,0,128,15},
    {82,0,161,15},
    {82,1,766,15},
    {83,0,128,15},
    {84,0,192,15},
    {84,1,574,15},
    {85,1,287,15},
    {86,0,114,15},
    {86,1,322,15},
    {87,1,287,15},
    {88,0,108,15},
    {88,1,430,15},
    {89,1,287,15},
    {90,0,108,0},
    {90,1,215,15},
    {91,1,171,15},
    {92,1,192,15},
    {93,1,287,15},
    {94,1,192,15},
    {95,1,161,15},
    {96,1,171,15},
    {97,0,144,15},
    {98,0,108,15},
    {98,1,215,15},
    {99,0,85,15},
    {100,0,96,15},
    {100,1,228,15},
    {101,0,144,15},
    {102,0,96,15},
    {102,1,287,15},
    {103,0,81,15},
    {104,0,85,15},
    {104,1,215,15},
    {105,1,287,15},
    {106,0,72,15},
    {106,1,215,15},
    {107,1,171,15},
    {108,0,114,15},
    {108,1,192,15},
    {109,1,287,15},
    {110,0,72,15},
    {110,1,192,15},
    {111,1,161,15},
    {112,0,108,15},
    {112,1,171,15},
    {113,0,144,15},
    {114,0,108,15},
    {114,1,215,15},
    {115,0,85,15},
    {116,0,96,15},
    {116,1,215,0},
    {117,0,144,15},
    {118,0,96,15},
    {119,0,81,15},
    {120,0,85,15},
    {121,1,144,15},
    {122,0,108,15},
    {122,1,171,15},
    {123,1,144,15},
    {124,0,72,15},
    {124,1,215,15},
    {125,1,171,15},
    {126,0,85,15},
    {126,1,287,15},
    {127,1,228,15},
    {128,0,54,15},
    {128,1,256,15},
    {129,0,64,15},
    {130,0,85,15},
    {130,1,215,15},
    {131,0,64,15},
    {132,0,108,15},
    {132,1,171,15},
    {133,0,85,15},
    {134,0,128,15},
    {134,1,144,15},
    {135,0,108,15},
    {136,0,96,15},
    {136,1,152,15},
    {137,1,128,15},
    {138,0,76,15},
    {138,1,192,15},
    {139,1,152,15},
    {140,0,64,15},
    {140,1,256,15},
    {141,1,192,15},
    {142,0,54,15},
    {142,1,304,15},
    {143,1,256,15},
    {144,0,57,15},
    {144,1,287,15},
    {145,0,72,15},
    {146,0,96,15},
    {146,1,228,15},
    {147,0,72,15},
    {148,0,114,15},
    {148,1,192,15},
    {149,0,96,15},
    {150,0,144,15},
    {150,1,152,15},
    {151,0,114,15},
    {152,0,108,15},
    {152,1,171,15},
    {153,1,144,15},
    {154,0,85,15},
    {154,1,215,15},
    {155,1,171,15},
    {156,0,72,15},
    {156,1,287,15},
    {157,1,215,15},
    {158,0,57,15},
    {158,1,341,15},
    {159,1,287,15},
    {160,0,64,15},
    {160,1,304,15},
    {161,0,76,15},
    {162,0,90,15},
    {162,1,256,15},
    {163,0,76,15},
    {164,0,114,15},
    {164,1,228,15},
    {165,0,90,15},
    {166,0,152,15},
    {166,1,181,15},
    {167,0,128,15},
    {168,0,144,15},
    {168,1,181,0},
    {169,1,171,15},
    {170,0,72,15},
    {170,1,215,15},
    {171,1,171,15},
    {172,1,256,15},
    {173,0,85,15},
    {173,1,215,15},
    {174,0,108,15},
    {174,1,171,15},
    {175,0,85,15},
    {175,1,144,15},
    {176,0,128,15},
    {176,1,152,15},
    {177,1,192,15},
    {178,0,76,15},
    {178,1,228,15},
    {179,1,192,15},
    {180,1,287,15},
    {181,0,96,15},
    {181,1,228,15},
    {182,0,114,15},
    {182,1,192,15},
    {183,0,96,15},
    {183,1,152,15},
    {184,0,144,15},
    {184,1,171,15},
    {185,1,215,15},
    {186,0,85,15},
    {186,1,256,15},
    {187,1,215,15},
    {188,1,304,15},
    {189,0,108,15},
    {189,1,256,15},
    {190,0,128,15},
    {190,1,215,15},
    {191,0,108,15},
    {192,0,152,15},
    {193,0,72,15},
    {193,1,228,15},
    {194,0,76,15},
    {194,1,215,15},
    {195,0,85,15},
    {195,1,256,15},
    {196,0,90,15},
    {196,1,228,15},
    {197,0,76,15},
    {198,0,114,15},
    {198,1,456,15},
    {199,0,90,15},
    {200,0,85,15},
    {200,1,341,15},
    {201,1,171,15},
    {202,0,85,0},
    {202,1,228,15},
    {203,1,287,15},
    {204,1,341,15},
    {205,1,456,15},
    {206,1,574,15},
    {207,1,456,15},
    {208,1,683,15},
    {209,0,72,15},
    {210,0,60,15},
    {210,1,341,15},
    {211,0,72,15},
    {212,0,85,15},
    {212,1,287,15},
    {213,0,72,15},
    {214,0,102,15},
    {214,1,241,15},
    {215,0,85,15},
    {216,0,72,15},
    {216,1,406,15},
    {217,0,85,15},
    {218,0,102,15},
    {218,1,406,0},
    {219,0,85,15},
    {220,0,128,15},
    {221,0,128,0},
    {221,1,144,15},
    {222,1,161,15},
    {223,1,171,15},
    {224,1,192,15},
    {225,0,81,15},
    {226,0,64,15},
    {226,1,383,15},
    {227,0,81,15},
    {228,0,96,15},
    {228,1,322,15},
    {229,0,81,15},
    {230,0,114,15},
    {230,1,271,15},
    {231,0,96,15},
    {232,0,81,15},
    {232,1,456,15},
    {233,0,96,15},
    {234,0,114,15},
    {234,1,456,0},
    {235,0,96,15},
    {236,0,144,15},
    {237,0,144,0},
    {237,1,161,15},
    {238,1,171,15},
    {239,1,192,15},
    {240,1,215,15},
    {241,0,85,15},
    {242,0,72,15},
    {242,1,430,15},
    {243,0,85,15},
    {244,0,108,15},
    {244,1,341,15},
    {245,0,85,15},
    {246,0,128,15},
    {246,1,304,15},
    {247,0,108,15},
    {248,0,90,15},
    {248,1,512,15},
    {249,0,108,15},
    {250,0,128,15},
    {250,1,512,0},
    {251,0,108,15},
    {252,0,152,15},
    {253,0,152,0},
    {253,1,171,15},
    {254,1,181,15},
    {255,1,203,15},
    {256,1,228,15},
    {257,0,96,15},
    {258,0,81,15},
    {258,1,456,15},
    {259,0,96,15},
    {260,0,114,15},
    {260,1,383,15},
    {261,0,96,15},
    {262,0,135,15},
    {262,1,322,15},
    {263,0,114,15},
    {264,0,96,15},
    {264,1,542,15},
    {265,0,114,15},
    {266,0,135,15},
    {266,1,542,0},
    {267,0,114,15},
    {268,0,171,15},
    {269,0,171,0},
    {269,1,192,15},
    {270,1,215,15},
    {271,1,228,15},
    {272,1,215,15},
    {273,0,171,15},
    {274,0,128,15},
    {274,1,256,15},
    {275,0,108,15},
    {276,0,114,15},
    {276,1,271,15},
    {277,0,171,15},
    {278,0,114,15},
    {278,1,341,15},
    {279,0,96,15},
    {280,0,108,15},
    {280,1,256,15},
    {281,1,341,15},
    {282,0,128,15},
    {282,1,256,15},
    {283,1,215,15},
    {284,0,135,15},
    {284,1,228,15},
    {285,1,341,15},
    {286,0,171,15},
    {286,1,228,15},
    {287,1,192,15},
    {288,0,128,15},
    {288,1,215,15},
    {289,0,108,15},
    {289,1,171,15},
    {290,0,85,15},
    {290,1,128,15},
    {291,0,108,15},
    {291,1,171,15},
    {292,0,128,15},
    {292,1,215,15},
    {293,0,108,15},
    {293,1,171,15},
    {294,0,152,15},
    {294,1,256,15},
    {295,0,128,15},
    {295,1,215,15},
    {296,0,108,15},
    {296,1,304,15},
    {297,0,128,15},
    {297,1,256,15},
    {298,0,152,15},
    {298,1,215,15},
    {299,0,128,15},
    {299,1,256,15},
    {300,0,181,15},
    {300,1,304,15},
    {301,0,108,15},
    {301,1,256,15},
    {302,0,114,15},
    {302,1,362,15},
    {303,0,128,15},
    {303,1,304,15},
    {304,0,135,15},
    {304,1,341,15},
    {305,0,114,15},
    {306,0,96,15},
    {306,1,271,15},
    {307,0,114,15},
    {308,0,135,15},
    {308,1,228,15},
    {309,0,114,15},
    {310,0,192,15},
    {310,1,271,15},
    {311,0,161,15},
    {312,0,135,15},
    {312,1,341,15},
    {313,0,161,15},
    {314,0,192,15},
    {314,1,456,15},
    {315,0,161,15},
    {316,0,228,15},
    {316,1,542,15},
    {317,0,161,15},
    {318,0,171,15},
    {318,1,683,15},
    {319,0,192,15},
    {320,0,215,15},
    {320,1,512,15},
    {321,0,171,15},
    {322,0,128,15},
    {322,1,430,15},
    {323,0,171,15},
    {324,0,215,15},
    {324,1,341,15},
    {325,0,171,15},
    {326,0,256,15},
    {326,1,430,15},
    {327,0,215,15},
    {328,0,181,15},
    {328,1,512,15},
    {329,0,215,15},
    {330,0,256,15},
    {330,1,430,15},
    {331,0,215,15},
    {332,0,304,15},
    {332,1,723,15},
    {333,0,215,15},
    {334,0,228,15},
    {334,1,723,0},
    {335,0,256,15},
    {336,0,271,15},
    {337,1,228,15},
    {338,0,114,15},
    {338,1,271,15},
    {339,1,341,15},
    {340,0,135,15},
    {340,1,383,15},
    {341,1,228,15},
    {342,0,171,15},
    {342,1,271,15},
    {343,1,383,15},
    {344,0,171,0},
    {344,1,430,15},
    {345,0,171,15},
    {346,0,128,15},
    {346,1,341,15},
    {347,0,108,15},
    {348,0,114,15},
    {348,1,542,15},
    {349,0,171,15},
    {350,0,114,15},
    {350,1,341,15},
    {351,0,96,15},
    {352,0,108,15},
    {352,1,512,15},
    {353,0,128,15},
    {354,0,108,15},
    {354,1,304,15},
    {355,0,85,15},
    {356,0,96,15},
    {356,1,456,15},
    {357,0,114,15},
    {358,0,96,15},
    {358,1,271,15},
    {359,0,81,15},
    {360,0,85,15},
    {360,1,430,15},
    {361,0,108,15},
    {362,0,85,15},
    {362,1,256,15},
    {363,0,72,15},
    {364,0,81,15},
    {364,1,383,15},
    {365,0,85,15},
    {366,0,96,15},
    {366,1,241,15},
    {367,0,108,15},
    {368,0,114,15},
    {368,1,271,15},
    {369,0,108,15},
    {370,0,96,15},
    {370,1,322,15},
    {371,0,85,15},
    {372,0,81,15},
    {372,1,383,15},
    {373,0,96,15},
    {374,0,68,15},
    {374,1,456,15},
    {375,0,96,15},
    {376,0,57,15},
    {376,1,542,15},
    {377,0,96,15},
    {378,0,108,15},
    {378,1,512,15},
    {379,0,64,15},
    {380,0,81,15},
    {380,1,766,15},
    {381,0,96,15},
    {382,0,114,15},
    {382,1,683,15},
    {383,0,96,15},
    {384,0,135,15},
    {384,1,644,15},
    {385,0,114,15},
    {386,0,108,15},
    {386,1,723,15},
    {387,0,128,15},
    {388,0,171,15},
    {388,1,683,15},
    {389,0,128,15},
    {390,0,114,15},
    {390,1,341,15},
    {391,0,135,15},
    {392,0,128,15},
    {392,1,512,15},
    {393,0,171,15},
    {394,0,215,15},
    {395,0,171,15},
    {396,0,256,15},
    {400,0,256,0},
    {400,1,512,0},
};


int main()
{
  char buf2[60];
   silence();
   
   cls();
   drawGrid();

   int iNumNotes = sizeof ns / sizeof ns[0];
   int iEndOffset = ns[iNumNotes-1].iOffset;

   int j=0;
   for(unsigned int i=0;i<=iEndOffset;i++) {
      while(ns[j].iOffset <= i) {
        vArray_pitch[ ns[j].iChannel ] = ns[j].iPitch;
        vArray_volume [ ns[j].iChannel ] = ns[j].iVolume;
 
        j++;
        itoa(j, buf2, 16);
        strat(0,11,buf2);
        playVoices();
      }
      hold(400);
   }

   strat(30,14,"DONE.");
   silence();
   getchar();
   cls();
}