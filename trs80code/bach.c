#include <stdio.h> 
#include <stdlib.h>
#include <string.h>
#include <malloc.h>

#define byte unsigned char
#define charat(x,y,c)  memset(0x3c00+((y<<6) + x), c, 1);

#define mallocblock 2048
#define HOLD_TIME 1

__sfr __at 0x82 PORTX82;
__sfr __at 0x83 PORTX83;
__sfr __at 0x84 PORTX84;
__sfr __at 0x85 PORTX85;


long heap;
uint memBlockPtr = 47000;
int n;
int tickctr = 0;


int vArray_pitch[12];
byte vArray_volume[12];

byte bRunning = 1;

char buf[4];
uint temp2;
uint temp;

unsigned char bitArray[256] = {0,128,64,192,32,160,96,224,16,144,80,208,48,176,112,240,8,136,72,200,40,168,104,232,24,152,
    88,216,56,184,120,248,4,132,68,196,36,164,100,228,20,148,84,212,52,180,116,244,12,140,76,204,44,172,108,236,28,156,92,
    220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,
    58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,
    190,126,254,1,129,65,193,33,161,97,225,17,145,81,209,49,177,113,241,9,137,73,201,41,169,105,233,25,153,89,217,57,185,
    121,249,5,133,69,197,37,165,101,229,21,149,85,213,53,181,117,245,13,141,77,205,45,173,109,237,29,157,93,221,61,189,125,
    253,3,131,67,195,35,163,99,227,19,147,83,211,51,179,115,243,11,139,75,203,43,171,107,235,27,155,91,219,59,187,123,251,7,
    135,71,199,39,167,103,231,23,151,87,215,55,183,119,247,15,143,79,207,47,175,111,239,31,159,95,223,63,191,127,255}; 

#define reverseBits(v) bitArray[v]


void setVolume(byte bPort, byte bChipVoiceNum, byte bVolume) {
  byte bx;

  bx = (bChipVoiceNum << 5);
  bx = (bx | 0x90);
    bx = (bx | bVolume);
    bx = reverseBits(bx);

    switch(bPort) {
      case 0x82:
          PORTX82 = bx;
      break;

      case 0x83:
          PORTX83 = bx;
      break;

      case 0x84:
          PORTX84 = bx;
      break;

      default:
          PORTX85 = bx;
    }    
}

byte bPastVolume[12] = { 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255 };

void sound(byte bVoiceNumber, int pitch, byte volume) {
    byte bPort;
    byte bChipVoiceNum;
    byte rightfourbits;
    byte leftsixbits;
    byte b1;

    if(bVoiceNumber < 3) {
      bPort = 0x82;
      bChipVoiceNum = bVoiceNumber;
    }
    else if(bVoiceNumber < 6) {
      bPort = 0x83;
        bChipVoiceNum = bVoiceNumber - 3;
    }
    else if(bVoiceNumber < 9) {
      bPort = 0x84;
      bChipVoiceNum = bVoiceNumber - 6;
    }
    else {
      bPort = 0x85;
      bChipVoiceNum = bVoiceNumber - 9;
    }
    
    //if(bPastVolume[bVoiceNumber] != volume) {
      setVolume(bPort, bChipVoiceNum, 0x0f - volume);
    //  bPastVolume[bVoiceNumber] = volume;
    //}

    rightfourbits = (pitch & 0x000f);
    leftsixbits =   (byte)((int)(pitch & 0x03f0) >> 4);
    rightfourbits = (rightfourbits | 0x80);
    bChipVoiceNum = reverseBits(bChipVoiceNum) >> 5;
    b1 = reverseBits(rightfourbits);
    b1 = (b1 | bChipVoiceNum);
    leftsixbits = reverseBits(leftsixbits);

    switch(bPort) {
      case 0x82:
          PORTX82 = b1;
          PORTX82 = leftsixbits;
      break;

      case 0x83:
          PORTX83 = b1;
          PORTX83 = leftsixbits;
      break;

      case 0x84:
          PORTX84 = b1;
          PORTX84 = leftsixbits;
      break;

      default:
          PORTX85 = b1;
          PORTX85 = leftsixbits;
    }
}

#define charat(x,y,c)  memset(0x3c00+((y<<6) + x), c, 1);


void h_lineat(byte y, byte c) {
    void* p;
    uint cc = y;
    cc = cc * 64;

    p = 0x3c00 + cc;

    memset(p, c, 64);
}


void v_lineat(byte x, byte c) {
    for(uint j = 0; j < 16; j++) 
        charat(x, j, c);
}


void strat(byte x, byte y, char* s) {
    for(uint i = 0; i < strlen(s); i++) {
        charat(x+i,y,*(s+i));
    }
}
 

void drawGrid() {
   uint j;
   char buf[7];

   j=1;
   for(uint i = 2;i<62;i=i+5) {
     v_lineat(i+2, 0x95);
     sprintf(buf,"%02d", j);
     if(j < 13) {
       strat(i+4,3,buf);
     }
     charat(i+1,3,' ');

     j++;
   }

   h_lineat(12, 0x8c);
   h_lineat(13, ' ');
   h_lineat(14, ' ');
   h_lineat(15, ' ');

   h_lineat(0, ' ');
   h_lineat(1, ' ');
   h_lineat(2, ' ');
   h_lineat(4, 0x8c);

   strat(18,1,"  JS BACH - INVENTION 13");
}

char mult_lu1[12] = {4, 9, 14, 19, 24, 29, 34, 39, 44, 49, 54, 59};
char mult_lu2[12] = {7,12, 17, 22, 27, 32, 37, 42, 47, 52, 57, 62};

void playVoices() { 
    register byte i;
    // scroll screen   
    //memcpy(15424,15488,64);
    //memcpy(15488,15552,64);
    //memcpy(15552,15616,64);
    //memcpy(15616,15680,64);
    memcpy(15680,15744,64);
    memcpy(15744,15808,64);
    memcpy(15808,15872,64);
    memcpy(15872,15936,64);
    memcpy(15936,16000,64);
    memcpy(16000,16064,64);

    char j;
    for(i=0;i<12;i++) {
        sound(i, vArray_pitch[i], vArray_volume[i]);
        itoa(vArray_pitch[i], buf, 16);
        temp = vArray_volume[i];
        if(temp < 0x0a)
           temp+=48;
        else
           temp+=55;
        j = mult_lu1[i]+1;
        charat(j+1, 11, ' ');
        charat(j+2, 11, ' ');
        strat(j, 11, buf);
        charat(mult_lu2[i]+1,11, temp);
    }
}



void silence() {
    for(uint i=255;i>=249;i=i-2) {
        PORTX82 = i;
        PORTX83 = i;
        PORTX84 = i;
        PORTX85 = i;
    }
}

void hold(unsigned int x) {
    for(unsigned int y = 0; y<x;y++) {
      #pragma asm
      nop
      #pragma endasm
    }
}



//bach-invention-13_split.mid
//Tracks: 12
//Shortest note duration: 0.125000

int mscounter = 50;
typedef struct {
  int iOffset;
  char iChannel;
  int iPitch;
  char iVolume;
} notestruct;

const notestruct ns[] = {
{0,2,512,15},{1,0,171,15},{2,0,171,0},{2,1,128,15},{2,2,512,0},{2,3,256,15},{3,0,108,15},{3,1,128,0},
{4,0,108,0},{4,1,114,15},{5,0,171,15},{5,1,114,0},{6,0,171,0},{6,1,114,15},{6,2,271,15},{6,3,256,0},
{7,0,96,15},{7,1,114,0},{8,0,96,0},{8,1,108,15},{8,2,271,0},{8,3,256,15},{9,2,341,15},{9,3,256,0},
{10,0,85,15},{10,1,108,0},{10,2,341,0},{10,3,256,15},{11,2,215,15},{11,3,256,0},{12,0,85,0},{12,1,135,15},
{12,2,215,0},{12,3,228,15},{13,2,341,15},{13,3,228,0},{14,0,85,15},{14,1,135,0},{14,2,341,0},{14,3,228,15},
{15,2,192,15},{15,3,228,0},{16,0,85,0},{16,1,128,15},{16,2,192,0},{16,3,215,15},{17,0,171,15},{17,1,128,0},
{18,0,171,0},{18,1,128,15},{18,2,256,15},{18,3,215,0},{19,0,108,15},{19,1,128,0},{20,0,108,0},{20,1,114,15},
{20,2,256,0},{20,3,271,15},{21,0,171,15},{21,1,114,0},{22,0,171,0},{22,1,114,15},{22,2,341,15},{22,3,271,0},
{23,0,96,15},{23,1,114,0},{24,0,96,0},{24,1,108,15},{24,2,341,0},{24,3,256,15},{25,2,341,15},{25,3,256,0},
{26,0,128,15},{26,1,108,0},{26,2,341,0},{26,3,256,15},{27,1,215,15},{27,3,256,0},{28,0,128,0},{28,1,215,0},
{28,2,228,15},{29,0,341,15},{29,2,228,0},{30,0,341,0},{30,1,228,15},{31,0,192,15},{31,1,228,0},{32,0,192,0},
{32,2,215,15},{33,0,85,15},{34,0,85,0},{34,1,108,15},{34,2,215,0},{34,3,256,15},{35,0,85,15},{35,1,108,0},
{36,0,85,0},{36,1,128,15},{36,2,215,15},{36,3,256,0},{37,0,108,15},{37,1,128,0},{38,0,108,0},{38,1,171,15},
{38,2,215,0},{38,3,256,15},{39,0,144,15},{39,1,171,0},{40,0,144,0},{40,1,161,15},{40,2,192,15},{40,3,256,0},
{41,2,192,0},{41,3,256,15},{42,0,128,15},{42,1,161,0},{42,2,322,15},{42,3,256,0},{43,2,322,0},{43,3,256,15},
{44,0,128,0},{44,1,96,15},{44,2,383,15},{44,3,256,0},{45,2,383,0},{45,3,322,15},{46,0,81,15},{46,1,96,0},
{46,2,512,15},{46,3,322,0},{47,1,430,15},{47,2,512,0},{48,1,430,0},{48,2,456,15},{49,0,81,0},{49,1,96,15},
{50,0,114,15},{50,1,96,0},{50,2,456,0},{50,3,383,15},{51,0,114,0},{51,1,96,15},{52,0,144,15},{52,1,96,0},
{52,2,287,15},{52,3,383,0},{53,0,144,0},{53,1,114,15},{54,0,192,15},{54,1,114,0},{54,2,287,0},{54,3,228,15},
{55,0,192,0},{55,1,161,15},{56,0,171,15},{56,1,161,0},{57,2,287,15},{57,3,228,0},{58,0,171,0},{58,1,144,15},
{58,2,287,0},{58,3,341,15},{59,2,287,15},{59,3,341,0},{60,0,108,15},{60,1,144,0},{60,2,287,0},{60,3,430,15},
{61,2,341,15},{61,3,430,0},{62,0,108,0},{62,1,85,15},{62,2,341,0},{62,3,574,15},{63,0,456,15},{63,3,574,0},
{64,0,456,0},{64,2,512,15},{65,0,108,15},{65,1,85,0},{66,0,108,0},{66,1,128,15},{66,2,512,0},{66,3,430,15},
{67,0,108,15},{67,1,128,0},{68,0,108,0},{68,1,161,15},{68,2,383,15},{68,3,430,0},{69,2,383,0},{69,3,322,15},
{70,0,96,15},{70,1,161,0},{70,2,456,15},{70,3,322,0},{71,1,383,15},{71,2,456,0},{72,1,383,0},{72,2,574,15},
{73,0,96,0},{73,1,114,15},{74,0,144,15},{74,1,114,0},{74,2,574,0},{74,3,456,15},{75,0,144,0},{75,1,114,15},
{76,0,171,15},{76,1,114,0},{76,2,430,15},{76,3,456,0},{77,2,430,0},{77,3,341,15},{78,0,171,0},{78,1,108,15},
{78,2,512,15},{78,3,341,0},{79,0,430,15},{79,2,512,0},{80,0,430,0},{80,2,644,15},{81,0,128,15},{81,1,108,0},
{82,0,128,0},{82,1,161,15},{82,2,644,0},{82,3,766,15},{83,0,128,15},{83,1,161,0},{84,0,128,0},{84,1,192,15},
{84,2,574,15},{84,3,766,0},{85,2,574,0},{85,3,287,15},{86,0,114,15},{86,1,192,0},{86,2,322,15},{86,3,287,0},
{87,2,322,0},{87,3,287,15},{88,0,114,0},{88,1,108,15},{88,2,430,15},{88,3,287,0},{89,0,287,15},{89,2,430,0},
{90,0,287,0},{90,1,108,0},{90,2,215,15},{91,0,171,15},{91,2,215,0},{92,0,171,0},{92,1,192,15},{93,0,287,15},
{93,1,192,0},{94,0,287,0},{94,1,192,15},{95,0,161,15},{95,1,192,0},{96,0,161,0},{96,2,171,15},{97,0,144,15},
{98,0,144,0},{98,1,108,15},{98,2,171,0},{98,3,215,15},{99,0,85,15},{99,1,108,0},{100,0,85,0},{100,1,96,15},
{100,2,228,15},{100,3,215,0},{101,0,144,15},{101,1,96,0},{102,0,144,0},{102,1,96,15},{102,2,228,0},{102,3,287,15},
{103,0,81,15},{103,1,96,0},{104,0,81,0},{104,1,85,15},{104,2,215,15},{104,3,287,0},{105,2,215,0},{105,3,287,15},
{106,0,72,15},{106,1,85,0},{106,2,215,15},{106,3,287,0},{107,2,215,0},{107,3,171,15},{108,0,72,0},{108,1,114,15},
{108,2,192,15},{108,3,171,0},{109,2,192,0},{109,3,287,15},{110,0,72,15},{110,1,114,0},{110,2,192,15},{110,3,287,0},
{111,2,192,0},{111,3,161,15},{112,0,72,0},{112,1,108,15},{112,2,171,15},{112,3,161,0},{113,0,144,15},{113,1,108,0},
{114,0,144,0},{114,1,108,15},{114,2,171,0},{114,3,215,15},{115,0,85,15},{115,1,108,0},{116,0,85,0},{116,1,96,15},
{116,3,215,0},{117,0,144,15},{117,1,96,0},{118,0,144,0},{118,1,96,15},{119,0,81,15},{119,1,96,0},{120,0,81,0},
{120,1,85,15},{121,2,144,15},{122,0,108,15},{122,1,85,0},{122,2,144,0},{122,3,171,15},{123,2,144,15},{123,3,171,0},
{124,0,108,0},{124,1,72,15},{124,2,144,0},{124,3,215,15},{125,2,171,15},{125,3,215,0},{126,0,85,15},{126,1,72,0},
{126,2,171,0},{126,3,287,15},{127,2,228,15},{127,3,287,0},{128,0,85,0},{128,1,54,15},{128,2,228,0},{128,3,256,15},
{129,0,64,15},{129,1,54,0},{130,0,64,0},{130,1,85,15},{130,2,215,15},{130,3,256,0},{131,0,64,15},{131,1,85,0},
{132,0,64,0},{132,1,108,15},{132,2,215,0},{132,3,171,15},{133,0,85,15},{133,1,108,0},{134,0,85,0},{134,1,128,15},
{134,2,144,15},{134,3,171,0},{135,0,108,15},{135,1,128,0},{136,0,108,0},{136,1,96,15},{136,2,144,0},{136,3,152,15},
{137,2,128,15},{137,3,152,0},{138,0,76,15},{138,1,96,0},{138,2,128,0},{138,3,192,15},{139,2,152,15},{139,3,192,0},
{140,0,76,0},{140,1,64,15},{140,2,152,0},{140,3,256,15},{141,2,192,15},{141,3,256,0},{142,0,54,15},{142,1,64,0},
{142,2,192,0},{142,3,304,15},{143,2,256,15},{143,3,304,0},{144,0,54,0},{144,1,57,15},{144,2,256,0},{144,3,287,15},
{145,0,72,15},{145,1,57,0},{146,0,72,0},{146,1,96,15},{146,2,228,15},{146,3,287,0},{147,0,72,15},{147,1,96,0},
{148,0,72,0},{148,1,114,15},{148,2,228,0},{148,3,192,15},{149,0,96,15},{149,1,114,0},{150,0,96,0},{150,1,144,15},
{150,2,152,15},{150,3,192,0},{151,0,114,15},{151,1,144,0},{152,0,114,0},{152,1,108,15},{152,2,152,0},{152,3,171,15},
{153,2,144,15},{153,3,171,0},{154,0,85,15},{154,1,108,0},{154,2,144,0},{154,3,215,15},{155,2,171,15},{155,3,215,0},
{156,0,85,0},{156,1,72,15},{156,2,171,0},{156,3,287,15},{157,2,215,15},{157,3,287,0},{158,0,57,15},{158,1,72,0},
{158,2,215,0},{158,3,341,15},{159,2,287,15},{159,3,341,0},{160,0,57,0},{160,1,64,15},{160,2,287,0},{160,3,304,15},
{161,0,76,15},{161,1,64,0},{162,0,76,0},{162,1,90,15},{162,2,256,15},{162,3,304,0},{163,0,76,15},{163,1,90,0},
{164,0,76,0},{164,1,114,15},{164,2,256,0},{164,3,228,15},{165,0,90,15},{165,1,114,0},{166,0,90,0},{166,1,152,15},
{166,2,181,15},{166,3,228,0},{167,0,128,15},{167,1,152,0},{168,0,128,0},{168,1,144,15},{168,2,181,0},{169,2,171,15},
{170,0,72,15},{170,1,144,0},{170,2,171,0},{170,3,215,15},{171,1,171,15},{171,3,215,0},{172,1,171,0},{172,2,256,15},
{173,0,72,0},{173,1,85,15},{173,2,256,0},{173,3,215,15},{174,0,108,15},{174,1,85,0},{174,2,171,15},{174,3,215,0},
{175,0,108,0},{175,1,85,15},{175,2,171,0},{175,3,144,15},{176,0,128,15},{176,1,85,0},{176,2,152,15},{176,3,144,0},
{177,2,152,0},{177,3,192,15},{178,0,128,0},{178,1,76,15},{178,2,228,15},{178,3,192,0},{179,0,192,15},{179,2,228,0},
{180,0,192,0},{180,2,287,15},{181,0,96,15},{181,1,76,0},{181,2,287,0},{181,3,228,15},{182,0,96,0},{182,1,114,15},
{182,2,192,15},{182,3,228,0},{183,0,96,15},{183,1,114,0},{183,2,192,0},{183,3,152,15},{184,0,96,0},{184,1,144,15},
{184,2,171,15},{184,3,152,0},{185,2,171,0},{185,3,215,15},{186,0,85,15},{186,1,144,0},{186,2,256,15},{186,3,215,0},
{187,1,215,15},{187,2,256,0},{188,1,215,0},{188,2,304,15},{189,0,85,0},{189,1,108,15},{189,2,304,0},{189,3,256,15},
{190,0,128,15},{190,1,108,0},{190,2,215,15},{190,3,256,0},{191,0,128,0},{191,1,108,15},{192,0,152,15},{192,1,108,0},
{193,0,152,0},{193,1,72,15},{193,2,215,0},{193,3,228,15},{194,0,76,15},{194,1,72,0},{194,2,215,15},{194,3,228,0},
{195,0,76,0},{195,1,85,15},{195,2,215,0},{195,3,256,15},{196,0,90,15},{196,1,85,0},{196,2,228,15},{196,3,256,0},
{197,0,90,0},{197,1,76,15},{198,0,114,15},{198,1,76,0},{198,2,228,0},{198,3,456,15},{199,0,114,0},{199,1,90,15},
{200,0,85,15},{200,1,90,0},{200,2,341,15},{200,3,456,0},{201,1,171,15},{201,2,341,0},{202,0,85,0},{202,1,171,0},
{202,2,228,15},{203,0,287,15},{203,2,228,0},{204,0,287,0},{204,1,341,15},{205,0,456,15},{205,1,341,0},{206,0,456,0},
{206,1,574,15},{207,0,456,15},{207,1,574,0},{208,0,456,0},{208,2,683,15},{209,0,72,15},{210,0,72,0},{210,1,60,15},
{210,2,683,0},{210,3,341,15},{211,0,72,15},{211,1,60,0},{212,0,72,0},{212,1,85,15},{212,2,287,15},{212,3,341,0},
{213,0,72,15},{213,1,85,0},{214,0,72,0},{214,1,102,15},{214,2,287,0},{214,3,241,15},{215,0,85,15},{215,1,102,0},
{216,0,85,0},{216,1,72,15},{216,2,406,15},{216,3,241,0},{217,0,85,15},{217,1,72,0},{218,0,85,0},{218,1,102,15},
{218,2,406,0},{219,0,85,15},{219,1,102,0},{220,0,85,0},{220,1,128,15},{221,0,144,15},{221,1,128,0},{222,0,144,0},
{222,1,161,15},{223,0,171,15},{223,1,161,0},{224,0,171,0},{224,2,192,15},{225,0,81,15},{226,0,81,0},{226,1,64,15},
{226,2,192,0},{226,3,383,15},{227,0,81,15},{227,1,64,0},{228,0,81,0},{228,1,96,15},{228,2,322,15},{228,3,383,0},
{229,0,81,15},{229,1,96,0},{230,0,81,0},{230,1,114,15},{230,2,322,0},{230,3,271,15},{231,0,96,15},{231,1,114,0},
{232,0,96,0},{232,1,81,15},{232,2,456,15},{232,3,271,0},{233,0,96,15},{233,1,81,0},{234,0,96,0},{234,1,114,15},
{234,2,456,0},{235,0,96,15},{235,1,114,0},{236,0,96,0},{236,1,144,15},{237,0,161,15},{237,1,144,0},{238,0,161,0},
{238,1,171,15},{239,0,192,15},{239,1,171,0},{240,0,192,0},{240,2,215,15},{241,0,85,15},{242,0,85,0},{242,1,72,15},
{242,2,215,0},{242,3,430,15},{243,0,85,15},{243,1,72,0},{244,0,85,0},{244,1,108,15},{244,2,341,15},{244,3,430,0},
{245,0,85,15},{245,1,108,0},{246,0,85,0},{246,1,128,15},{246,2,341,0},{246,3,304,15},{247,0,108,15},{247,1,128,0},
{248,0,108,0},{248,1,90,15},{248,2,512,15},{248,3,304,0},{249,0,108,15},{249,1,90,0},{250,0,108,0},{250,1,128,15},
{250,2,512,0},{251,0,108,15},{251,1,128,0},{252,0,108,0},{252,1,152,15},{253,0,171,15},{253,1,152,0},{254,0,171,0},
{254,1,181,15},{255,0,203,15},{255,1,181,0},{256,0,203,0},{256,2,228,15},{257,0,96,15},{258,0,96,0},{258,1,81,15},
{258,2,228,0},{258,3,456,15},{259,0,96,15},{259,1,81,0},{260,0,96,0},{260,1,114,15},{260,2,383,15},{260,3,456,0},
{261,0,96,15},{261,1,114,0},{262,0,96,0},{262,1,135,15},{262,2,383,0},{262,3,322,15},{263,0,114,15},{263,1,135,0},
{264,0,114,0},{264,1,96,15},{264,2,542,15},{264,3,322,0},{265,0,114,15},{265,1,96,0},{266,0,114,0},{266,1,135,15},
{266,2,542,0},{267,0,114,15},{267,1,135,0},{268,0,114,0},{268,1,171,15},{269,0,192,15},{269,1,171,0},{270,0,192,0},
{270,1,215,15},{271,0,228,15},{271,1,215,0},{272,0,228,0},{272,2,215,15},{273,0,171,15},{274,0,171,0},{274,1,128,15},
{274,2,215,0},{274,3,256,15},{275,0,108,15},{275,1,128,0},{276,0,108,0},{276,1,114,15},{276,2,271,15},{276,3,256,0},
{277,0,171,15},{277,1,114,0},{278,0,171,0},{278,1,114,15},{278,2,271,0},{278,3,341,15},{279,0,96,15},{279,1,114,0},
{280,0,96,0},{280,1,108,15},{280,2,256,15},{280,3,341,0},{281,2,256,0},{281,3,341,15},{282,0,128,15},{282,1,108,0},
{282,2,256,15},{282,3,341,0},{283,2,256,0},{283,3,215,15},{284,0,128,0},{284,1,135,15},{284,2,228,15},{284,3,215,0},
{285,2,228,0},{285,3,341,15},{286,0,171,15},{286,1,135,0},{286,2,228,15},{286,3,341,0},{287,2,228,0},{287,3,192,15},
{288,0,171,0},{288,1,128,15},{288,2,215,15},{288,3,192,0},{289,0,108,15},{289,1,128,0},{289,2,215,0},{289,3,171,15},
{290,0,108,0},{290,1,85,15},{290,2,128,15},{290,3,171,0},{291,0,108,15},{291,1,85,0},{291,2,128,0},{291,3,171,15},
{292,0,108,0},{292,1,128,15},{292,2,215,15},{292,3,171,0},{293,0,108,15},{293,1,128,0},{293,2,215,0},{293,3,171,15},
{294,0,108,0},{294,1,152,15},{294,2,256,15},{294,3,171,0},{295,0,128,15},{295,1,152,0},{295,2,256,0},{295,3,215,15},
{296,0,128,0},{296,1,108,15},{296,2,304,15},{296,3,215,0},{297,0,128,15},{297,1,108,0},{297,2,304,0},{297,3,256,15},
{298,0,128,0},{298,1,152,15},{298,2,215,15},{298,3,256,0},{299,0,128,15},{299,1,152,0},{299,2,215,0},{299,3,256,15},
{300,0,128,0},{300,1,181,15},{300,2,304,15},{300,3,256,0},{301,0,108,15},{301,1,181,0},{301,2,304,0},{301,3,256,15},
{302,0,108,0},{302,1,114,15},{302,2,362,15},{302,3,256,0},{303,0,128,15},{303,1,114,0},{303,2,362,0},{303,3,304,15},
{304,0,128,0},{304,1,135,15},{304,2,341,15},{304,3,304,0},{305,0,114,15},{305,1,135,0},{306,0,114,0},{306,1,96,15},
{306,2,341,0},{306,3,271,15},{307,0,114,15},{307,1,96,0},{308,0,114,0},{308,1,135,15},{308,2,228,15},{308,3,271,0},
{309,0,114,15},{309,1,135,0},{310,0,114,0},{310,1,192,15},{310,2,228,0},{310,3,271,15},{311,0,161,15},{311,1,192,0},
{312,0,161,0},{312,1,135,15},{312,2,341,15},{312,3,271,0},{313,0,161,15},{313,1,135,0},{314,0,161,0},{314,1,192,15},
{314,2,341,0},{314,3,456,15},{315,0,161,15},{315,1,192,0},{316,0,161,0},{316,1,228,15},{316,2,542,15},{316,3,456,0},
{317,0,161,15},{317,1,228,0},{318,0,161,0},{318,1,171,15},{318,2,542,0},{318,3,683,15},{319,0,192,15},{319,1,171,0},
{320,0,192,0},{320,1,215,15},{320,2,512,15},{320,3,683,0},{321,0,171,15},{321,1,215,0},{322,0,171,0},{322,1,128,15},
{322,2,512,0},{322,3,430,15},{323,0,171,15},{323,1,128,0},{324,0,171,0},{324,1,215,15},{324,2,341,15},{324,3,430,0},
{325,0,171,15},{325,1,215,0},{326,0,171,0},{326,1,256,15},{326,2,341,0},{326,3,430,15},{327,0,215,15},{327,1,256,0},
{328,0,215,0},{328,1,181,15},{328,2,512,15},{328,3,430,0},{329,0,215,15},{329,1,181,0},{330,0,215,0},{330,1,256,15},
{330,2,512,0},{330,3,430,15},{331,0,215,15},{331,1,256,0},{332,0,215,0},{332,1,304,15},{332,2,723,15},{332,3,430,0},
{333,0,215,15},{333,1,304,0},{334,0,215,0},{334,1,228,15},{334,2,723,0},{335,0,256,15},{335,1,228,0},{336,0,256,0},
{336,1,271,15},{337,2,228,15},{338,0,114,15},{338,1,271,0},{338,2,228,0},{338,3,271,15},{339,2,341,15},{339,3,271,0},
{340,0,114,0},{340,1,135,15},{340,2,341,0},{340,3,383,15},{341,2,228,15},{341,3,383,0},{342,0,171,15},{342,1,135,0},
{342,2,228,0},{342,3,271,15},{343,1,383,15},{343,3,271,0},{344,0,171,0},{344,1,383,0},{344,2,430,15},{345,0,171,15},
{346,0,171,0},{346,1,128,15},{346,2,430,0},{346,3,341,15},{347,0,108,15},{347,1,128,0},{348,0,108,0},{348,1,114,15},
{348,2,542,15},{348,3,341,0},{349,0,171,15},{349,1,114,0},{350,0,171,0},{350,1,114,15},{350,2,542,0},{350,3,341,15},
{351,0,96,15},{351,1,114,0},{352,0,96,0},{352,1,108,15},{352,2,512,15},{352,3,341,0},{353,0,128,15},{353,1,108,0},
{354,0,128,0},{354,1,108,15},{354,2,512,0},{354,3,304,15},{355,0,85,15},{355,1,108,0},{356,0,85,0},{356,1,96,15},
{356,2,456,15},{356,3,304,0},{357,0,114,15},{357,1,96,0},{358,0,114,0},{358,1,96,15},{358,2,456,0},{358,3,271,15},
{359,0,81,15},{359,1,96,0},{360,0,81,0},{360,1,85,15},{360,2,430,15},{360,3,271,0},{361,0,108,15},{361,1,85,0},
{362,0,108,0},{362,1,85,15},{362,2,430,0},{362,3,256,15},{363,0,72,15},{363,1,85,0},{364,0,72,0},{364,1,81,15},
{364,2,383,15},{364,3,256,0},{365,0,85,15},{365,1,81,0},{366,0,85,0},{366,1,96,15},{366,2,383,0},{366,3,241,15},
{367,0,108,15},{367,1,96,0},{368,0,108,0},{368,1,114,15},{368,2,271,15},{368,3,241,0},{369,0,108,15},{369,1,114,0},
{370,0,108,0},{370,1,96,15},{370,2,271,0},{370,3,322,15},{371,0,85,15},{371,1,96,0},{372,0,85,0},{372,1,81,15},
{372,2,383,15},{372,3,322,0},{373,0,96,15},{373,1,81,0},{374,0,96,0},{374,1,68,15},{374,2,383,0},{374,3,456,15},
{375,0,96,15},{375,1,68,0},{376,0,96,0},{376,1,57,15},{376,2,542,15},{376,3,456,0},{377,0,96,15},{377,1,57,0},
{378,0,96,0},{378,1,108,15},{378,2,542,0},{378,3,512,15},{379,0,64,15},{379,1,108,0},{380,0,64,0},{380,1,81,15},
{380,2,766,15},{380,3,512,0},{381,0,96,15},{381,1,81,0},{382,0,96,0},{382,1,114,15},{382,2,766,0},{382,3,683,15},
{383,0,96,15},{383,1,114,0},{384,0,96,0},{384,1,135,15},{384,2,644,15},{384,3,683,0},{385,0,114,15},{385,1,135,0},
{386,0,114,0},{386,1,108,15},{386,2,644,0},{386,3,723,15},{387,0,128,15},{387,1,108,0},{388,0,128,0},{388,1,171,15},
{388,2,683,15},{388,3,723,0},{389,0,128,15},{389,1,171,0},{390,0,128,0},{390,1,114,15},{390,2,683,0},{390,3,341,15},
{391,0,135,15},{391,1,114,0},{392,0,135,0},{392,1,128,15},{392,2,512,15},{392,3,341,0},{393,0,171,15},{393,1,128,0},
{394,0,171,0},{394,1,215,15},{395,0,171,15},{395,1,215,0},{396,0,171,0},{396,1,256,15},{400,1,256,0},{400,2,512,0}
};
int nsArrayLen = 1128;





int iSongPos = 0;
int noteStructPos = 0;
void stepNote() {

   if(ns[noteStructPos].iOffset < iSongPos)  // do nothing if we're behind the position in the song
       return;

   while(ns[noteStructPos].iOffset == iSongPos) {
      vArray_pitch[ns[noteStructPos].iChannel] = ns[noteStructPos].iPitch;
      vArray_volume[ns[noteStructPos].iChannel] = ns[noteStructPos].iVolume;
      noteStructPos++;

      if(noteStructPos >= nsArrayLen) {
        bRunning = 0;
        iSongPos = 0;
      }
   }

   playVoices();
   hold(150);
   iSongPos++;

}



// invoked approximately once every 25ms
void T25MsEvent() {
  tickctr++;
  if(tickctr >= mscounter) {
    tickctr = 0;
    stepNote();
  }
}


void tick(byte T25Milliseconds)  {
  for(byte c = 0; c <= T25Milliseconds; c++)
      T25MsEvent();
} 

void cls() {
   void* p = 0x3c00;
   memset(p, ' ', 0x3ff);
}



int main()
{
    char work[8];
    char* cp = 0x3810;

    silence();
    cls();
    drawGrid();

    int* p = 0x4040;
    int oldp;
    int dif;

    oldp = (*p);
    while(bRunning == 1) {
      dif = (*p) - oldp;
      oldp = (*p);      
      if(dif < 0) dif = -dif;
      if(dif >= 253) dif = dif - 253;
      if(dif > 14000) dif = 2;
      
      tick(dif);
    }
    strat(30,14,"DONE.");
    
    silence();
    getchar();
    cls();
}